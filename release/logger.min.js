/*! weblogng-logger - v0.6.4 - 2015-03-17
* https://github.com/weblogng/weblogng-client-javascript
* Copyright (c) 2015 Stephen Kuenzli; Licensed MIT */
(function(){var a;a=this,"undefined"!=typeof window&&null!==window&&(window.weblogng=a),a.generateUniqueId=function(a){var b;for(null==a&&(a=12),b="";b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)},a.throttle=function(a,b){var c;return 0===b?a:(c=!1,function(){var d;if(!c)return c=!0,d=function(){return c=!1},-1!==b&&setTimeout(d,b),a.apply(null,arguments)})},a.epochTimeInMilliseconds=function(){return(new Date).getTime()},a.epochTimeInSeconds=function(){return Math.round((new Date).getTime()/1e3)},a.locatePerformanceObject=function(){return window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance},a.locateNavigatorObject=function(){return navigator},a.getUserAgent=function(){var a;return a=locateNavigatorObject(),a&&a.userAgent?a.userAgent:void 0},a.hasNavigationTimingAPI=function(){var a;return(null!=(a=locatePerformanceObject())?a.timing:void 0)?!0:!1},a.patterns={MATCH_LEADING_AND_TRAILING_SLASHES:/^\/+|\/+$/g,MATCH_SLASHES:/\/+/g,MATCH_FORBIDDEN_METRIC_NAME_CHARS:/[^\w\d\:\\?\=\/\\\._\-\%]+/g},a.toPageName=function(a){var b;return a&&a.pathname?(b=a.pathname.replace(patterns.MATCH_LEADING_AND_TRAILING_SLASHES,"").replace(patterns.MATCH_SLASHES,"-"),""===b?"root":b):"unknown-page"},a.addListener=function(a,b,c){if(a&&b&&c){if(a.addEventListener)return a.addEventListener(b,c,!0);if(a.attachEvent)return a.attachEvent(b,c,!0)}},a.APIConnection=function(){function a(a){this.apiUrl=a}return a.prototype.send=function(a){var b;b=new XMLHttpRequest,b.open("POST",this.apiUrl,!0),b.setRequestHeader("Content-Type","application/json"),b.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),b.send(JSON.stringify(a))},a}(),a.Timer=function(){function a(){}return a.prototype.start=function(){this.tStart=epochTimeInMilliseconds()},a.prototype.finish=function(){this.tFinish=epochTimeInMilliseconds()},a.prototype.getElapsedTime=function(){return this.tFinish-this.tStart},a}(),a.Scope=function(){function a(){}return a.APPLICATION="application",a}(),a.Category=function(){function a(){}return a.NAVIGATION_TIMING="navigation timing",a}(),a.Logger=function(){function b(b,c,d){var e,f,g;this.apiHost=b,this.apiKey=c,this.options=null!=d?d:{publishNavigationTimingMetrics:!0,publishUserActive:!0,application:""},this.id=generateUniqueId(),this.apiUrl="https://"+b+"/v2/log",this.defaultContext={},this.apiConnection=this._createAPIConnection(this.apiUrl),this.timers={},this.buffers={events:[],metrics:[]},this.userActivityCheckInterval=6e4,this.timeOfLastUserActivity=epochTimeInMilliseconds(),this.publishNavigationTimingMetrics=null!=(e=this.options&&this.options.publishNavigationTimingMetrics)?e:{"true":!1},this.publishUserActive=null!=(f=this.options&&this.options.publishUserActive)?f:{"true":!1},this.options&&this.options.application?this.defaultContext.application=this.options.application:delete this.defaultContext.application,this.publishNavigationTimingMetrics&&hasNavigationTimingAPI()&&this._initNavigationTimingPublishProcess(),this.publishUserActive&&this._initUserActivityPublishProcess(),g=function(a){return function(){return a._sendToAPI()}}(this),this._throttledSendToAPI=a.throttle(g,5e3)}return b.prototype._addAttributesToLogItem=function(a,b,c){return b&&(a.scope=b),c&&(a.category=c),a},b.prototype.makeEvent=function(a,b,c,d){var e;return null==b&&(b=epochTimeInMilliseconds()),null==c&&(c=Scope.APPLICATION),null==d&&(d=void 0),e={name:a,timestamp:b},this._addAttributesToLogItem(e,c,d)},b.prototype.makeMetric=function(a,b,c,d,e){var f;return null==c&&(c=epochTimeInMilliseconds()),null==d&&(d=Scope.APPLICATION),null==e&&(e=void 0),f={name:a,value:b,unit:"ms",timestamp:c},this._addAttributesToLogItem(f,d,e)},b.prototype._sendToAPI=function(){var a,b;return a=this.buffers.events,b=this.buffers.metrics,this.buffers.events=[],this.buffers.metrics=[],this.apiConnection.send(this._createLogMessage(a,b))},b.prototype._triggerSendToAPI=function(){return this._throttledSendToAPI()},b.prototype.sendMetric=function(a,b,c,d,e){return null==c&&(c=epochTimeInMilliseconds()),null==d&&(d=Scope.APPLICATION),null==e&&(e=void 0),this.buffers.metrics.push(this.makeMetric(a,b,c,d,e)),this._triggerSendToAPI()},b.prototype._createAPIConnection=function(b){return new a.APIConnection(b)},b.prototype._createLogMessage=function(a,b){var c,d,e,f,g,h,i,j,k;for(null==a&&(a=[]),null==b&&(b=[]),h=0,j=a.length;j>h;h++)d=a[h],d.name=this._sanitizeMetricName(d.name);for(i=0,k=b.length;k>i;i++)f=b[i],f.name=this._sanitizeMetricName(f.name);return c={},this.options.application&&(c.application=this.options.application),g=getUserAgent(),g&&(c.userAgent=g),e={apiAccessKey:this.apiKey,context:c,events:a,metrics:b}},b.prototype._sanitizeMetricName=function(a){return a.replace(patterns.MATCH_FORBIDDEN_METRIC_NAME_CHARS," ")},b.prototype.recordStart=function(b){var c;return c=new a.Timer,c.start(),this.timers[b]=c,c},b.prototype.recordFinish=function(a){var b;return this.timers[a]?(b=this.timers[a],b.finish(),b):null},b.prototype.recordFinishAndSendMetric=function(a){var b;b=this.recordFinish(a),b&&(this.sendMetric(a,b.getElapsedTime()),delete this.timers[a])},b.prototype.executeWithTiming=function(b,c){var d,e;if(c){e=new a.Timer,e.start();try{c(),e.finish(),this.sendMetric(b,e.getElapsedTime())}catch(f){d=f}}},b.prototype.recordEvent=function(a,b,c,d){return null==b&&(b=epochTimeInMilliseconds()),null==c&&(c=Scope.APPLICATION),null==d&&(d=void 0),this.buffers.events.push(this.makeEvent(a,b,c,d)),this._triggerSendToAPI()},b.prototype._initNavigationTimingPublishProcess=function(){var a;hasNavigationTimingAPI()&&(a=function(a){return function(){return a._publishNavigationTimingData()}}(this),this._waitForReadyStateComplete(a,10))},b.prototype._waitForReadyStateComplete=function(a,b){b--,setTimeout(function(c){return function(){return"complete"!==document.readyState?b>0?(console.log("WeblogNG: readyState was not complete, "+b+" re-scheduling"),c._waitForReadyStateComplete(a,b)):console.log("WeblogNG: readyState is not complete and no attempts remain; giving-up"):void(null!=a&&a())}}(this),1e3)},b.prototype._publishNavigationTimingData=function(){var a,b;b=this._generateNavigationTimingData(),a=this._createLogMessage(b.events,b.metrics),this.apiConnection.send(a)},b.prototype._generateNavigationTimingData=function(){var b,c,d,e,f,g,h,i;return g=locatePerformanceObject(),h=toPageName(location),b=a.Category.NAVIGATION_TIMING,i=epochTimeInMilliseconds(),d=[],f=[],g.timing.dnsLookupStart>0&&g.timing.dnsLookupEnd>0&&(e=this.makeMetric("dns_lookup_time",g.timing.dnsLookupEnd-g.timing.dnsLookupStart,i,h,b),f.push(e)),g.timing.connectStart>0&&g.timing.responseStart>0&&(e=this.makeMetric("first_byte_time",g.timing.responseStart-g.timing.connectStart,i,h,b),f.push(e)),g.timing.responseStart>0&&g.timing.responseEnd>0&&(e=this.makeMetric("response_recv_time",g.timing.responseEnd-g.timing.responseStart,i,h,b),f.push(e)),g.timing.loadEventStart>0&&(e=this.makeMetric("page_load_time",g.timing.loadEventStart-g.timing.navigationStart,i,h,b),f.push(e),d.push(this.makeEvent("page_load",i,h,b))),c={metrics:f,events:d}},b.prototype._initUserActivityPublishProcess=function(a){var b;return null==a&&(a=window),b=function(a){return function(){return a._userActivityOccurred()}}(this),addListener(a,"mousemove",b),addListener(a,"keyup",b),this._scheduleRecurringUserActivityPublish()},b.prototype._userActivityOccurred=function(){this.timeOfLastUserActivity=epochTimeInMilliseconds()},b.prototype._scheduleRecurringUserActivityPublish=function(){var a;return a=function(a){return function(){return a._recordRecentUserActivity()}}(this),setInterval(a,this.userActivityCheckInterval)},b.prototype._recordRecentUserActivity=function(){var a,b;return a=epochTimeInMilliseconds(),b=a-this.userActivityCheckInterval,this.timeOfLastUserActivity>b&&this.timeOfLastUserActivity<=a?this.recordEvent("user_active",this.timeOfLastUserActivity):void 0},b.prototype.toString=function(){return"[Logger id: "+this.id+", apiHost: "+this.apiHost+", apiKey: "+this.apiKey+" ]"},b}()}).call(this);